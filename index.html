<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>One Rule at a Time</title>
<style>
body {
  margin:0;
  background:#111;
  display:flex;
  justify-content:center;
  align-items:center;
  height:100vh;
  font-family:monospace;
  color:white;
}
canvas {
  background:black;
  border:2px solid white;
}
</style>
</head>
<body>

<canvas id="game"></canvas>

<script>
/* =====================================================
   基础设置
===================================================== */
const TILE = 32;
const COLS = 20;
const ROWS = 20;

const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");
canvas.width  = COLS * TILE;
canvas.height = ROWS * TILE;

/* =====================================================
   关卡数据
===================================================== */
const LEVELS = [
  { // ---------- Level 1 ----------
    start:{x:1,y:1,rule:1},
    rule2Collapses:false,
    map:[
[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
[1,0,0,0,1,2,2,2,1,0,0,0,2,2,2,0,0,0,3,1],
[1,0,1,0,1,2,1,2,1,0,1,0,1,1,2,1,1,0,1,1],
[1,0,1,0,0,2,1,2,0,0,1,0,0,0,2,0,1,0,0,1],
[1,0,1,1,1,1,1,2,1,1,1,1,1,0,2,1,1,1,0,1],
[1,0,0,0,0,0,0,2,0,0,0,0,1,0,2,2,2,0,0,1],
[1,1,1,1,1,1,0,1,1,1,1,0,1,1,1,1,2,1,0,1],
[1,0,0,0,0,0,0,0,1,0,0,0,0,0,0,1,2,0,0,1],
[1,0,1,1,1,1,1,0,1,0,1,1,1,1,0,1,2,1,1,1],
[1,0,0,0,0,0,1,0,0,0,2,2,2,1,0,0,2,2,0,1],
[1,1,1,1,1,0,1,1,1,1,1,1,2,1,1,1,1,2,0,1],
[1,0,0,0,1,0,2,2,2,0,0,1,2,0,0,0,1,2,0,1],
[1,0,1,0,1,1,1,1,2,1,0,1,1,1,1,0,1,2,0,1],
[1,0,1,0,0,0,0,0,2,1,0,0,0,0,1,0,2,2,0,1],
[1,0,0,0,1,1,1,1,2,1,1,1,1,0,1,1,1,2,0,1],
[1,1,1,0,1,2,2,2,2,0,0,0,1,0,0,0,0,2,0,1],
[1,0,0,0,1,2,1,1,1,1,1,0,1,1,1,1,0,2,0,1],
[1,0,1,1,1,2,1,0,0,0,1,0,0,0,0,1,0,2,0,1],
[1,0,0,0,0,2,2,2,1,0,1,1,1,1,0,0,0,0,0,1],
[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
]
  },
  { // ---------- Level 2 ----------
    start:{x:1,y:1,rule:1},
    rule2Collapses:true,
    map:[
[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
[1,0,0,0,1,2,2,2,1,0,0,0,0,0,0,0,0,0,3,1],
[1,0,1,0,1,2,1,2,1,0,1,1,1,1,1,1,1,0,1,1],
[1,0,1,0,0,2,1,2,0,0,0,0,0,0,0,0,1,0,0,1],
[1,0,1,1,1,1,1,2,1,1,1,1,1,1,1,0,1,1,0,1],
[1,0,0,0,0,0,0,2,0,0,0,0,1,0,2,2,2,0,0,1],
[1,1,1,1,1,1,0,1,1,1,1,0,1,1,1,1,2,1,0,1],
[1,0,0,0,0,0,0,0,1,0,0,0,0,0,0,1,2,0,0,1],
[1,0,1,1,1,1,1,0,1,0,1,1,1,1,0,1,2,1,1,1],
[1,0,0,0,0,0,1,0,0,0,2,2,2,1,0,0,0,0,0,1],
[1,1,1,1,1,0,1,1,1,1,1,1,2,1,1,1,1,1,0,1],
[1,0,0,0,1,0,2,2,2,0,0,1,0,0,0,0,1,1,0,1],
[1,0,1,0,1,1,1,1,2,1,0,1,1,1,1,0,1,1,0,1],
[1,0,1,0,0,0,0,0,2,1,0,0,0,0,1,0,0,0,0,1],
[1,0,0,0,1,1,1,1,2,1,1,1,1,0,1,1,1,1,0,1],
[1,1,1,0,1,2,2,2,2,0,0,0,1,0,0,0,0,1,0,1],
[1,0,0,0,1,2,1,1,1,1,1,0,1,1,1,1,0,1,0,1],
[1,0,1,1,1,2,1,0,0,0,1,0,0,0,0,1,0,1,0,1],
[1,0,0,0,0,2,2,2,1,0,1,1,1,1,0,0,0,0,0,1],
[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
]
  }
];

let levelIndex = 0;
let map, player, rule, rule2Collapsed;

/* =====================================================
   可解性检查（从当前位置）
===================================================== */
function solveMapFrom(sx, sy, sr) {
  const dirs = [
    {x:0,y:-1},{x:0,y:1},{x:-1,y:0},{x:1,y:0}
  ];
  const deque = [];
  const visited = new Set();
  const key = (x,y,r)=>`${x},${y},${r}`;

  deque.push({x:sx,y:sy,r:sr});
  visited.add(key(sx,sy,sr));

  while (deque.length) {
    const cur = deque.shift();

    // 免费切 rule
    for (const nr of [1,2,3]) {
      if (nr !== cur.r) {
        const k = key(cur.x,cur.y,nr);
        if (!visited.has(k)) {
          visited.add(k);
          deque.unshift({x:cur.x,y:cur.y,r:nr});
        }
      }
    }

    // 移动
    for (const d of dirs) {
      let dx=d.x, dy=d.y;
      if (cur.r===3){dx*=-1;dy*=-1;}
      const nx=cur.x+dx, ny=cur.y+dy;
      if(nx<0||ny<0||nx>=COLS||ny>=ROWS) continue;

      const tile=map[ny][nx];
      if(tile===1) continue;
      if(tile===2 && cur.r!==2) continue;
      if(tile===0 && cur.r===2) continue;

      if(tile===3 && cur.r===3) return true;

      const k=key(nx,ny,cur.r);
      if(!visited.has(k)){
        visited.add(k);
        deque.push({x:nx,y:ny,r:cur.r});
      }
    }
  }
  return false;
}

/* =====================================================
   加载关卡
===================================================== */
function loadLevel(i){
  levelIndex=i;
  const L=LEVELS[i];
  map=JSON.parse(JSON.stringify(L.map));
  player={...L.start};
  rule=player.rule;
  rule2Collapsed=false;
}
loadLevel(0);

/* =====================================================
   输入 & 规则
===================================================== */
document.addEventListener("keydown",e=>{
  if(["1","2","3"].includes(e.key)){
    if (
      rule===2 &&
      e.key!=="2" &&
      LEVELS[levelIndex].rule2Collapses &&
      !rule2Collapsed
    ) {
      collapseRule2();
      rule2Collapsed=true;

      const ok = solveMapFrom(player.x, player.y, Number(e.key));
      if(!ok){
        alert("World collapsed into an unsolvable state.");
        loadLevel(1);
        return;
      }
    }
    rule=Number(e.key);
  }

  let dx=0,dy=0;
  if(e.key==="ArrowUp"||e.key==="w") dy=-1;
  if(e.key==="ArrowDown"||e.key==="s") dy=1;
  if(e.key==="ArrowLeft"||e.key==="a") dx=-1;
  if(e.key==="ArrowRight"||e.key==="d") dx=1;

  if(rule===3){dx*=-1;dy*=-1;}
  if(dx||dy) move(dx,dy);
});

function collapseRule2(){
  for(let y=0;y<ROWS;y++){
    for(let x=0;x<COLS;x++){
      if(map[y][x]===2) map[y][x]=1;
    }
  }
}

function move(dx,dy){
  const nx=player.x+dx, ny=player.y+dy;
  const tile=map[ny][nx];
  if(tile===1) return;
  if(tile===2 && rule!==2) return;
  if(tile===0 && rule===2) return;

  player.x=nx; player.y=ny;

  if(tile===3 && rule===3){
    if(levelIndex===0) loadLevel(1);
    else loadLevel(1);
  }
}

/* =====================================================
   绘制
===================================================== */
function draw(){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  for(let y=0;y<ROWS;y++){
    for(let x=0;x<COLS;x++){
      ctx.fillStyle="#222";
      ctx.fillRect(x*TILE,y*TILE,TILE,TILE);
      if(map[y][x]===1) ctx.fillStyle="#555";
      if(map[y][x]===2 && rule===2) ctx.fillStyle="purple";
      if(map[y][x]===3 && rule===3) ctx.fillStyle="lime";
      if(map[y][x]!==0) ctx.fillRect(x*TILE,y*TILE,TILE,TILE);
    }
  }
  ctx.fillStyle=["white","cyan","yellow"][rule-1];
  ctx.fillRect(player.x*TILE+6,player.y*TILE+6,TILE-12,TILE-12);

  ctx.fillStyle="white";
  ctx.fillText(`Level ${levelIndex+1}`,10,14);

  requestAnimationFrame(draw);
}
draw();
</script>

</body>
</html>
